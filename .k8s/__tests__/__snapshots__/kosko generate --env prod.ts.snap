// Jest Snapshot v1, https://goo.gl/fbAQLP

exports[`kosko generate --prod 1`] = `
"---
apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    kapp.k14s.io/disable-default-ownership-label-rules: ''
    kapp.k14s.io/disable-default-label-scoping-rules: ''
    app.gitlab.com/app: socialgouv-serving-ml
    app.gitlab.com/env: prod2
    app.gitlab.com/env.name: prod2
  labels:
    app: serving-ml-cache
    application: serving-ml
    owner: serving-ml
    team: serving-ml
  name: serving-ml-cache
  namespace: serving-ml
spec:
  replicas: 1
  selector:
    matchLabels:
      app: serving-ml-cache
  template:
    metadata:
      annotations:
        kapp.k14s.io/disable-default-ownership-label-rules: ''
        kapp.k14s.io/disable-default-label-scoping-rules: ''
        app.gitlab.com/app: socialgouv-serving-ml
        app.gitlab.com/env: prod2
        app.gitlab.com/env.name: prod2
      labels:
        app: serving-ml-cache
        application: serving-ml
        owner: serving-ml
        team: serving-ml
    spec:
      containers:
        - image: nginx:1.19.6
          livenessProbe:
            failureThreshold: 6
            httpGet:
              path: /v1/models/sentqam
              port: http
            initialDelaySeconds: 15
            periodSeconds: 5
            timeoutSeconds: 15
          name: serving-ml-cache
          ports:
            - containerPort: 80
              name: http
          readinessProbe:
            failureThreshold: 15
            httpGet:
              path: /v1/models/sentqam
              port: http
            initialDelaySeconds: 5
            periodSeconds: 5
            successThreshold: 1
            timeoutSeconds: 3
          resources:
            limits:
              cpu: 1000m
              memory: 1Gi
            requests:
              cpu: 100m
              memory: 0.5Gi
          startupProbe:
            failureThreshold: 12
            httpGet:
              path: /v1/models/sentqam
              port: http
            periodSeconds: 5
            initialDelaySeconds: 0
            timeoutSeconds: 15
          env:
            - name: UPSTREAM
              value: http://serving-ml
            - name: MAX_SIZE
              value: 1024m
          volumeMounts:
            - mountPath: /var/cache/nginx
              name: cache
            - mountPath: /etc/nginx/nginx.conf
              subPath: nginx.conf
              name: config
          envFrom:
            - secretRef:
                name: cache-sealed-secret
      volumes:
        - name: cache
          azureFile:
            secretName: cache-sealed-secret
            shareName: http-cache
            readOnly: false
        - name: config
          configMap:
            name: nginx-config
---
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  annotations:
    kapp.k14s.io/disable-default-ownership-label-rules: ''
    kapp.k14s.io/disable-default-label-scoping-rules: ''
    app.gitlab.com/app: socialgouv-serving-ml
    app.gitlab.com/env: prod2
    app.gitlab.com/env.name: prod2
  name: cache-sealed-secret
  namespace: serving-ml
  labels:
    application: serving-ml
    owner: serving-ml
    team: serving-ml
spec:
  encryptedData:
    azurestorageaccountname: >-
      AgCVik60mjKsz3pqN2YE14mY/9gbEion+7qhl9L/+kNMQwE6KUtPWYMKAXKseXlA64BQtymtWM4q0Ow/3OcfBps+c/ATaqMyvOFXw6NfGXDvEQ27dRlBkcu3azgz/JDEGJIYuZ8HMnKw1oZGTC89oZ2haAsB3OGcnf9vkfBqD2R7zTCL0xSoNTWTtMVrjVTs8fx0TbDugt9NnTbECJc7WB3Nid8KCmc76x4nHPCQs8RTx353TkgH7YUEkoZxltEqeTuEeY6eBBsSTnTgRibIC0wrgAJqIXqln8T0YuFxZTIfIvh48yFLMoOgM0kXuM15gn7SdND4nr/FMsHAIKFHkrqQFrHPOaBplKIdiIRxl3X3txNrplVrGZDgRVo4FNGS0ciunAm0XpThCAxuD3cW6l0W/ynJwpbFIHMY/6jgRTQQvkTAKUAppJtjX2KV83ue5fSEpaH3WZdllk2/hTRtSsxn33BsB+GYf++FeoHunzXRbnwr2ZONo+Kql1CDvAB3gvL7f/BZgymAhb361M5nO7Y/CbpBtHmktW9RADusKfe6kyZYX4gtmAMrWtC+9cQGFU3G8rCwAstHzcnRJcP7GDWU6bwb5kOr4Ghh+HSiZYNK7MLUUSlTahUkSzW1fzvkZsT8kgpbkTvmudhsvnoHf3pt/TKUOW3P1ksOnNqhJ8Fu3bYfjI7D1t9v/Lt3oF07mN6H/VqrhnpCG/Y+Xw+Z
    azurestorageaccountkey: >-
      AgCmk6JmDy2Bn1RTpCxsQCvbAsQGe4gCZ4S8VqbDQZi71V5nHU0r+y7qEn6fdsQ3+m/RFS1/CcjnChJxreGL2wFZ3Ux/eQ1f+G+DMEo482tgelmT8C62ZCIhgz4JqVAdAnlij+JvnhLcOrGhc+zYUPzFtpxRSA8l/w+8GQIvW4ezdK2RrCSGAvj/h82c71i7PEIp1HlMTwAvQhsuornQ/6KNK2WvB3Do0RHid6H7lB64ESNX5f3sSeUXRuJBPahZg+Ppq0u8AcrQg5TB2fgLcY+0uVG/gT86+7peJ6B+7+D7CiV0FavIQ4mPtUx7oBF7wUP2xwHDYA+B3zsSFk6MbdhepA8YYCXMQEXlK153xW5VzVAvQyf/srou6PcznrsI1W7Nd0YbcfC8bUHf+MRONmRIK17pdnCvwAKSXQvEX0jGT6FWB3+S9esqdCDQau4/STPjmMvCfTtTNSJqv41DjIThPHsOycd3wZYPbTAaH7FwRq06IRaiDj3FR4E+/H4LhsA9DqrkdwPLP/U8xufbH2dyQsqR16PJoAnF8MbQ8pBfDf5iD9/amg5Tcc4/PAsRjusaYuHwZfRqQbwVfxCOrKxGPbyynuJkkTiO9UwvgQGttpHt4Yw9fvI3LifOqg2b2Pbh6yTY3nEbg7LYryzoEaLtrZWIsIpuGipAYYLVBgk4HV3+AkiuHcYWsnKUbiEx9HzwXpaDJZLd15XrRdzlPhCaKFqr2oXS7uUQTlUmGPA9MZc/7EHb6k1N8JDH3p025HhNrvBL6WTgJTWq3G+VMkrRs0QZcEZXFsSLsIpWcQ+T8Z+x+sQ66vPC
  template:
    metadata:
      annotations:
        kapp.k14s.io/disable-default-ownership-label-rules: ''
        kapp.k14s.io/disable-default-label-scoping-rules: ''
        app.gitlab.com/app: socialgouv-serving-ml
        app.gitlab.com/env: prod2
        app.gitlab.com/env.name: prod2
      name: cache-sealed-secret
      labels:
        application: serving-ml
        owner: serving-ml
        team: serving-ml
    type: Opaque
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: serving-ml-cache
    application: serving-ml
    owner: serving-ml
    team: serving-ml
  name: serving-ml-cache
  annotations:
    kapp.k14s.io/disable-default-ownership-label-rules: ''
    kapp.k14s.io/disable-default-label-scoping-rules: ''
    app.gitlab.com/app: socialgouv-serving-ml
    app.gitlab.com/env: prod2
    app.gitlab.com/env.name: prod2
  namespace: serving-ml
spec:
  ports:
    - name: http
      port: 80
      targetPort: 80
  selector:
    app: serving-ml-cache
  type: ClusterIP
---
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  annotations:
    kubernetes.io/ingress.class: nginx
    certmanager.k8s.io/cluster-issuer: letsencrypt-prod
    kubernetes.io/tls-acme: 'true'
    kapp.k14s.io/disable-default-ownership-label-rules: ''
    kapp.k14s.io/disable-default-label-scoping-rules: ''
    app.gitlab.com/app: socialgouv-serving-ml
    app.gitlab.com/env: prod2
    app.gitlab.com/env.name: prod2
  labels:
    app: serving-ml-cache
    application: serving-ml
    owner: serving-ml
    team: serving-ml
  name: serving-ml-cache
  namespace: serving-ml
spec:
  rules:
    - host: serving-ml.fabrique.social.gouv.fr
      http:
        paths:
          - backend:
              serviceName: serving-ml-cache
              servicePort: 80
            path: /
  tls:
    - hosts:
        - serving-ml.fabrique.social.gouv.fr
      secretName: serving-ml-cache-crt
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
data:
  nginx.conf: |

    events {
      worker_connections 1024;
    }

    http {
      include mime.types;
      default_type application/octet-stream;
      sendfile on;
      keepalive_timeout 65;
      client_max_body_size 200k;

      proxy_buffering on;
      proxy_cache_path /cache levels=1:2 keys_zone=small:1m inactive=1w use_temp_path=off;

      server {
        listen 80;
        server_name localhost;

        location / {
          try_files $uri @backend;
        }

        location @backend {
          proxy_cache small;
          proxy_cache_methods POST;
          proxy_pass http://serving-ml:80;
          proxy_cache_key \\"$request_uri|$request_body\\";
          proxy_cache_valid any 1w;
          proxy_buffers 8 32k;
          proxy_buffer_size 64k;
          proxy_cache_use_stale updating;
          add_header X-Cached $upstream_cache_status;
        }
      }
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    kapp.k14s.io/disable-default-ownership-label-rules: ''
    kapp.k14s.io/disable-default-label-scoping-rules: ''
    app.gitlab.com/app: socialgouv-serving-ml
    app.gitlab.com/env: prod2
    app.gitlab.com/env.name: prod2
  labels:
    app: serving-ml
    application: serving-ml
    owner: serving-ml
    team: serving-ml
  name: serving-ml
  namespace: serving-ml
spec:
  replicas: 1
  selector:
    matchLabels:
      app: serving-ml
  template:
    metadata:
      annotations:
        kapp.k14s.io/disable-default-ownership-label-rules: ''
        kapp.k14s.io/disable-default-label-scoping-rules: ''
        app.gitlab.com/app: socialgouv-serving-ml
        app.gitlab.com/env: prod2
        app.gitlab.com/env.name: prod2
      labels:
        app: serving-ml
        application: serving-ml
        owner: serving-ml
        team: serving-ml
    spec:
      containers:
        - image: harbor.fabrique.social.gouv.fr/cdtn/serving-ml:1.2.3
          livenessProbe:
            failureThreshold: 6
            httpGet:
              path: /v1/models/sentqam
              port: http
            initialDelaySeconds: 15
            periodSeconds: 5
            timeoutSeconds: 15
          name: serving-ml
          ports:
            - containerPort: 8501
              name: http
          readinessProbe:
            failureThreshold: 15
            httpGet:
              path: /v1/models/sentqam
              port: http
            initialDelaySeconds: 5
            periodSeconds: 5
            successThreshold: 1
            timeoutSeconds: 3
          resources:
            limits:
              cpu: 1000m
              memory: 2Gi
            requests:
              cpu: 500m
              memory: 1.5Gi
          startupProbe:
            failureThreshold: 12
            httpGet:
              path: /v1/models/sentqam
              port: http
            periodSeconds: 5
            initialDelaySeconds: 0
            timeoutSeconds: 15
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: serving-ml
    application: serving-ml
    owner: serving-ml
    team: serving-ml
  name: serving-ml
  annotations:
    kapp.k14s.io/disable-default-ownership-label-rules: ''
    kapp.k14s.io/disable-default-label-scoping-rules: ''
    app.gitlab.com/app: socialgouv-serving-ml
    app.gitlab.com/env: prod2
    app.gitlab.com/env.name: prod2
  namespace: serving-ml
spec:
  ports:
    - name: http
      port: 80
      targetPort: 8501
  selector:
    app: serving-ml
  type: ClusterIP
"
`;
