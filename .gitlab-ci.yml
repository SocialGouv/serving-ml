include:
  - project: SocialGouv/gitlab-ci-yml
    file: /autodevops.yml
    ref: v20.4.1
  - project: SocialGouv/gitlab-ci-yml
    file: /base_kaniko_stage.yml
    ref: v20.4.1

variables:
  AUTO_DEVOPS_RELEASE_AUTO: "ðŸ”–"
  AUTO_DEVOPS_PRODUCTION_AUTO: "ðŸš€"
  
  
.base_register_stage:
  image:
    name: gcr.io/kaniko-project/executor:v1.3.0-debug
    entrypoint: [""]
  script:
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"$HARBOR_REGISTRY\":{\"username\":\"$HARBOR_USERNAME\",\"password\":\"$HARBOR_PASSWORD\"}}}" > /kaniko/.docker/config.json
    - |
      if [[ -n "${CI_COMMIT_TAG}" ]]; then
        export TAG=$(printf "${CI_COMMIT_TAG}" | sed "s/^v//")
      else
        export TAG=$CI_COMMIT_REF_SLUG
      fi
      if [[ "${CONTEXT}" == "." ]]; then
        export KANIKO_CONTEXT=$PWD
      elif [[ -n "${CONTEXT}" ]]; then
        export KANIKO_CONTEXT=$PWD/$CONTEXT
      else
        export KANIKO_CONTEXT=$PWD
      fi
    - |
      echo "*******************************************************************"
      echo Build docker image and publish to ${HARBOR_REGISTRY}
      echo Context ${KANIKO_CONTEXT}
      echo Build args ${DOCKER_BUILD_ARGS}
      echo Publish to ${HARBOR_PROJECT}/${IMAGE_NAME}:${CI_COMMIT_SHA}
      echo Publish to ${HARBOR_PROJECT}/${IMAGE_NAME}:${TAG}
      echo "*******************************************************************"
    - /kaniko/executor
      --verbosity info
      --context dir:///${KANIKO_CONTEXT}
      --destination ${HARBOR_REGISTRY}/${HARBOR_PROJECT}/${IMAGE_NAME}:${CI_COMMIT_SHA}
      --destination ${HARBOR_REGISTRY}/${HARBOR_PROJECT}/${IMAGE_NAME}:${TAG}
      $DOCKER_BUILD_ARGS
    - |
      echo "*******************************************************************"
      echo ðŸ“¦ ${HARBOR_REGISTRY}/${HARBOR_PROJECT}/${IMAGE_NAME}:${CI_COMMIT_SHA}
      echo ðŸ“¦ ${HARBOR_REGISTRY}/${HARBOR_PROJECT}/${IMAGE_NAME}:${TAG}
      echo "*******************************************************************"

Install:
  rules:
    - when: never

Lint:
  needs: []
  image: hadolint/hadolint:v1.18.1-debian
  script:
    - hadolint ./Dockerfile

Test:
  rules:
    - when: never

Build:
  rules:
    - when: never

Preprod:
  environment:
    auto_stop_in: 6 months

Register image:
  extends: .autodevops_register_image
  needs: []
  variables:
    IMAGE_NAME: serving-ml
